<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Watch the Tournament</title>
<style>
  :root{
    --accent:#30f470; --bg:#000; --panel:#0f0f0f; --text:#f2f2f2; --muted:#a0a0a0; --border:#1a1a1a; --twitch:#9146ff;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1200px;margin:auto;padding:28px 16px 72px}
  h1{font-weight:900;margin:0 0 6px;font-size:clamp(24px,3vw,36px)}
  .sub{color:var(--muted);margin:0 0 18px;font-size:14.5px}
  h2{margin:22px 0 10px;font-size:20px}
  .search{position:relative;min-width:240px;max-width:420px}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0e0e0e;color:var(--text)}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;gap:12px;align-items:center}
  .card--official{border-color:#2a2a2a; box-shadow:0 0 0 1px #2a2a2a inset}
  .avatar{width:48px;height:48px;border-radius:12px;background:#111;object-fit:cover}
  .fb{width:48px;height:48px;border-radius:12px;background:#111;display:flex;align-items:center;justify-content:center;font-weight:900;color:#e5e5e5}
  .meta{display:grid;gap:4px;flex:1}
  .name{font-weight:900}
  .handle{color:var(--muted);font-size:12px}
  .badge{font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid #2a2a2a;background:#101010;white-space:nowrap;color:var(--twitch);border-color:var(--twitch)}
  .btn{margin-left:auto;background:#121212;border:1px solid #2a2a2a;color:#fff;padding:8px 12px;border-radius:10px;font-weight:800;text-decoration:none}
  .btn:hover{border-color:#3a3a3a}
  .empty{color:#9ca3af;margin:10px 0 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Watch the Tournament</h1>
  <p class="sub">Official broadcast + player streams. Click any card to open the Twitch channel.</p>

  <div class="search"><input id="search" type="search" placeholder="Search name or handle…"></div>

  <section>
    <h2>Official Broadcast</h2>
    <div id="official" class="grid"></div>
    <div id="official-empty" class="empty" style="display:none">No official broadcast set yet.</div>
  </section>

  <section>
    <h2>Player Streams</h2>
    <div id="players" class="grid"></div>
    <div id="players-empty" class="empty" style="display:none">No player streams match your search.</div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

 // Firebase config (Sherpa Hub project)
  const firebaseConfig = {
    apiKey: "AIzaSyDZPD8nUaLXmKbosAVnzs3btqf-8KDGTas",
    authDomain: "eft-sherpa-hub.firebaseapp.com",
    projectId: "eft-sherpa-hub",
    storageBucket: "eft-sherpa-hub.firebasestorage.app",
    messagingSenderId: "831895286596",
    appId: "1:831895286596:web:f381dc5e199c0e27bd9d11"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

 // DOM refs
  const officialEl = document.getElementById('official');
  const officialEmpty = document.getElementById('official-empty');
  const playersEl = document.getElementById('players');
  const playersEmpty = document.getElementById('players-empty');
  const searchEl = document.getElementById('search'); // optional search input

 // --- Helpers ---
  function initials(n){ return (n||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||'').join('') || '??'; }

 // Parse Twitch from stream_link or a bare username
  function parseTwitch(raw){
    if (!raw) return "";
    let s = String(raw).trim();
    if (/^(twitch\.tv|www\.twitch\.tv)\//i.test(s)) s = 'https://' + s;
    let m = s.match(/^https?:\/\/(?:www\.)?twitch\.tv\/([^/?#]+)/i);
    if (m) return m[1].toLowerCase();
 // bare username
    if (/^[A-Za-z0-9_]{3,25}$/.test(s)) return s.toLowerCase();
    return "";
  }

  function twitchUrl(channel){ return channel ? `https://twitch.tv/${encodeURIComponent(channel)}` : "#"; }

  function handleOf(d){
    const raw = String(d.discord_id||'').trim();
    return (raw && !raw.startsWith('@') && !raw.includes('#') && /^[\w.\-]{2,32}$/.test(raw)) ? '@'+raw : raw;
  }

  function officialCardHTML(b){
    const url = b.stream_link || twitchUrl(b.channel);
    const thumb = b.thumb_url
      ? `<img class="avatar" loading="lazy" src="${b.thumb_url}" alt="thumb" onerror="this.style.display='none'">`
      : `<div class="fb">${initials(b.title||'—')}</div>`;
    return `
      <article class="card card--official" onclick="window.open('${url}','_blank','noopener')">
        ${thumb}
        <div class="meta">
          <div class="name">${b.title||'—'}</div>
          <div class="handle">Official · Twitch</div>
        </div>
        <a class="btn" href="${url}" target="_blank" rel="noopener">Open</a>
      </article>
    `;
  }

  function playerCardHTML(p){
    const avatar = p.avatar_url
      ? `<img class="avatar" loading="lazy" src="${p.avatar_url}" alt="avatar"
           onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'fb',textContent:'${initials(p.name)}'}))">`
      : `<div class="fb">${initials(p.name)}</div>`;
    const url = twitchUrl(p.channel);
    return `
      <article class="card" onclick="window.open('${url}','_blank','noopener')">
        ${avatar}
        <div class="meta">
          <div class="name">${p.name||'—'}</div>
          <div class="handle">${handleOf(p)||''}</div>
          <div><span class="badge twitch">Twitch</span></div>
        </div>
        <a class="btn" href="${url}" target="_blank" rel="noopener">Open</a>
      </article>
    `;
  }

 // --- State ---
  let ALL_OFFICIAL = [];  // from broadcasts/
  let ALL_PLAYERS  = [];  // from signups/

 // --- Loaders ---
  async function loadOfficial(){
    ALL_OFFICIAL = [];
    try{
      const snap = await getDocs(collection(db,'broadcasts'));
      snap.forEach(docSnap=>{
        const d = docSnap.data();
 // Only Twitch now
        if (d.platform && d.platform !== 'twitch') return;

 // Normalize channel (optional but useful fallback)
        let channel = d.channel || parseTwitch(d.stream_link);
        const item = {
          id: docSnap.id,
          title: d.title || 'Official Broadcast',
          stream_link: d.stream_link || twitchUrl(channel),
          channel,
          order: Number(d.order||0),
          live: !!d.live,
          thumb_url: d.thumb_url || '',
          description: d.description || ''
        };
        ALL_OFFICIAL.push(item);
      });

 // Sort: live first, then order, then title
      ALL_OFFICIAL.sort((a,b)=> Number(b.live)-Number(a.live) || a.order-b.order || (a.title||'').localeCompare(b.title||''));
    }catch(e){
      console.error('loadOfficial failed:', e);
    }
  }

  async function loadPlayers(){
    ALL_PLAYERS = [];
    try{
      const snap = await getDocs(collection(db,'signups'));
      snap.forEach(docSnap=>{
        const x = docSnap.data();
 // must not be deleted
        if (x.deleted===true) return;

 // must indicate streams yes
        if (String(x.streams||'no').toLowerCase() !== 'yes') return;

 // normalize twitch channel from existing fields or stream_link
        let channel = '';
        if ((x.platform||'') === 'twitch' && x.channel) channel = String(x.channel).toLowerCase();
        if (!channel) channel = parseTwitch(x.stream_link);

        if (!channel){
          console.debug('[skip player: no twitch channel]', docSnap.id, x.name, x.stream_link, x.platform, x.channel);
          return;
        }

        ALL_PLAYERS.push({
          id: docSnap.id,
          name: x.name || '—',
          discord_id: x.discord_id || '',
          avatar_url: x.avatar_url || '',
 // official flag reused if you want to show staff picks at top
          featured: !!x.featured,
          feature_order: Number(x.feature_order||0),
          channel
        });
      });

 // Sort: featured first (by feature_order), then name
      ALL_PLAYERS.sort((a,b)=>
        Number(b.featured)-Number(a.featured) ||
        (a.feature_order - b.feature_order) ||
        (a.name||'').localeCompare(b.name||'')
      );
    }catch(e){
      console.error('loadPlayers failed:', e);
    }
  }

 // --- Render ---
  function render(){
 // Official
    if (officialEl){
      officialEl.innerHTML = ALL_OFFICIAL.map(officialCardHTML).join('');
      if (officialEmpty) officialEmpty.style.display = ALL_OFFICIAL.length ? 'none' : 'block';
    }

 // Player streams (search optional)
    let list = [...ALL_PLAYERS];
    const q = (searchEl?.value || '').trim().toLowerCase();
    if (q){
      list = list.filter(d=> (String(d.name||'') + ' ' + handleOf(d)).toLowerCase().includes(q));
    }
    playersEl.innerHTML = list.map(playerCardHTML).join('');
    playersEmpty.style.display = list.length ? 'none' : 'block';
  }

 // Wire search (optional)
  if (searchEl) searchEl.addEventListener('input', ()=> render());

 // --- Boot ---
  async function boot(){
 // load both in parallel
    await Promise.all([loadOfficial(), loadPlayers()]);
    render();
  }
  boot();
</script>

</body>
</html>